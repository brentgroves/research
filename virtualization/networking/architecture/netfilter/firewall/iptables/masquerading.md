# what is masquerading in iptables

**[Research List](../../../../../research_list.md)**\
**[Detailed Status](../../../../../../a_status/detailed_status.md)**\
**[Curent Tasks](../../../../../../a_status/current_tasks.md)**\

**[Main](../../../../../../README.md)**

In iptables, masquerading, a form of SNAT (Source Network Address Translation), allows multiple internal network devices to share a single external IP address, effectively hiding their private IPs behind the router's public IP.

Note: We could use masquerading if our host has multiple networks with multiple IPs. So we could configure one natter with VLan 50's IP and another natter with VLan 220's IP.

Here's a more detailed explanation:
What it does:
Masquerading translates the source IP addresses of packets originating from a private network to the public IP address of the router's external interface.

When to use it:
When you have a private network (LAN) and want to allow devices on that network to access the internet.
When you only have one public IP address for your network.
When the external IP address of the interface is not known or changes dynamically.

## How it works

1. A device on the private network initiates a connection to a server on the internet.
2. The packet, originating from the private IP address, is intercepted by the router.
3. The router's iptables NAT masquerade rule translates the source IP address to the router's public IP.
4. The modified packet is sent out to the internet, appearing to come from the router.
5. When the response packet returns, the router uses the same translation to route it back to the original device on the private network.

## Example iptables command

```bash
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE. 
-t nat: Specifies the NAT table. 
-A POSTROUTING: Appends a rule to the POSTROUTING chain. 
-o eth0: Specifies the outgoing interface (e.g., eth0). 
-j MASQUERADE: Sets the target to MASQUERADE. 

```

## **[6.1.1. Differences Between SNAT and Masquerading](http://linux-ip.net/html/snat-intro.html)**

Though SNAT and masquerading perform the same fundamental function, mapping one address space into another one, the details differ slighly. Most noticeably, masquerading chooses the source IP address for the outbound packet from the IP bound to the interface through which the packet will exit.

Difference from SNAT:
While both SNAT and masquerade are forms of NAT, masquerade is a special case of SNAT that is used when the external IP address is not known or changes dynamically. SNAT requires you to specify the external IP address, while masquerade uses the IP address of the interface.

SNAT Example:
If a device with the internal IP 192.168.1.10 wants to access the internet, and the firewall's public IP is 203.0.113.1, the SNAT rule will change the source IP of the packet from 192.168.1.10 to 203.0.113.1 before sending it out.
Masquerade vs SNAT:
Masquerade is a type of SNAT, but it dynamically uses the outgoing interface's IP address for translation, while SNAT allows you to specify a fixed IP address.

## **[answer](https://askubuntu.com/questions/466445/what-is-masquerade-in-the-context-of-iptables#:~:text=MASQUERADE%20is%20an%20iptables%20target,server%20gets%20external%20ip%20dynamically).)**

After study of above answers, this is what caused me to understand:

Masquerading allows an entire network of internal IP addresses to operate through one external IP address. As a side effect, masquerading allows conversion from one protocol to another (wired/wireless).

When the MASQUERADE chain sends a datagram from a computer it...

Takes note of the type of datagram it is, "TCP," "UDP," "ICMP," etc. Note: An unknown might not work correctly through MASQUERADE.
Modifies the datagram so that it looks like it was generated by the router machine itself (the one external address).
Remembers that it has done so, recording the local source and external destination IPs.
Transmits the datagram onto the Internet with the single external IP address.
Note: When the destination host receives this datagram, it believes the datagram has come from the one routing host and sends any reply datagrams back to that address.

When the Linux MASQUERADE chain receives a datagram from its Internet connection,

It looks in its table of established masqueraded connections to see if this datagram actually belongs to a computer on the LAN.
If it does, it reverses the modification it did on the forward path and transmits the datagram to the LAN computer.
The MASQUERADE chain is useful for internally creating and entire private IP address space, and for forwarding packets that would otherwise be incompatible.

The Ethernet, or wired protocol, assumes that the packet comes from the source and reports itself. The Wifi, or wireless protocol, assumes that the packet is being repeated and reports itself and the original source.

For this reason, Wifi and Ethernet cannot be directly bridged because they are incompatible. Masquerading causes the packets to be rebuilt and will thereby handle conversion between wired and wireless standards. Note: There are ways to cause your computer to accept the incompatibility internally and bridge, but without a full masquerade, the bridge spoof will be viewed externally as a security risk and those requests will be rejected.

## SNAT

Example iptables -t nat -A POSTROUTING -p tcp -o eth0 -j SNAT --to-source 194.236.50.155-194.236.50.160:1024-32000
Explanation The --to-source option is used to specify which source the packet should use. This option, at its simplest, takes one IP address which we want to use for the source IP address in the IP header. If we want to balance between several IP addresses, we can use a range of IP addresses, separated by a hyphen. The --to--source IP numbers could then, for instance, be something like in the above example: 194.236.50.155-194.236.50.160. The source IP for each stream that we open would then be allocated randomly from these, and a single stream would always use the same IP address for all packets within that stream. We can also specify a range of ports to be used by SNAT. All the source ports would then be confined to the ports specified. The port bit of the rule would then look like in the example above, :1024-32000. This is only valid if -p tcp or -p udp was specified somewhere in the match of the rule in question. iptables will always try to avoid making any port alterations if possible, but if two hosts try to use the same ports, iptables will map one of them to another port. If no port range is specified, then if they're needed, all source ports below 512 will be mapped to other ports below 512. Those between source ports 512 and 1023 will be mapped to ports below 1024. All other ports will be mapped to 1024 or above. As previously stated, iptables will always try to maintain the source ports used by the actual workstation making the connection. Note that this has nothing to do with destination ports, so if a client tries to make contact with an HTTP server outside the firewall, it will not be mapped to the FTP control port.
